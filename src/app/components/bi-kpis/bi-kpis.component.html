<app-menu></app-menu>
<div class="bi-kpis-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando datos de BI y KPIs...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <p><span class="material-icons error-icon">error</span> Error: {{ error }}</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading && !error" class="content">
      <div class="page-header">
        <h1><span class="material-icons header-icon">insights</span> Business Intelligence & KPIs</h1>
        <p class="subtitle">Panel de análisis y métricas del sistema</p>
      </div>

      <!-- KPIs Section - 3 Cards Horizontal -->
      <div class="kpis-section">
        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">trending_up</span></div>
          <div class="kpi-content">
            <h3>Tasa de Crecimiento</h3>
            <div *ngIf="kpiCrecimiento; else noKpi">
              <div class="kpi-value">{{ kpiCrecimiento!.growth_percent }}%</div>
              <div class="kpi-details">
                <span>{{ kpiCrecimiento!.current_month }}: {{ kpiCrecimiento!.current_total }} citas</span>
                <span>{{ kpiCrecimiento!.previous_month }}: {{ kpiCrecimiento!.previous_total }} citas</span>
              </div>
            </div>
            <ng-template #noKpi>
              <div class="kpi-value">-</div>
              <div class="kpi-details">Sin datos</div>
            </ng-template>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">check_circle</span></div>
          <div class="kpi-content">
            <h3>Asistencia</h3>
            <div *ngIf="kpiAsistencia; else noAsistencia">
              <div class="kpi-value">{{ kpiAsistencia!.percent }}%</div>
              <div class="kpi-details">
                <span>{{ kpiAsistencia!.attended }} de {{ kpiAsistencia!.total }} citas</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" [style.width.%]="kpiAsistencia!.percent"></div>
              </div>
            </div>
            <ng-template #noAsistencia>
              <div class="kpi-value">-</div>
              <div class="kpi-details">Sin datos</div>
            </ng-template>
          </div>
        </div>

        <!-- KPIs comentados - No son verdaderos KPIs
        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">event</span></div>
          <div class="kpi-content">
            <h3>Total Citas</h3>
            <div class="kpi-value">{{ totalCitas }}</div>
            <div class="kpi-details">
              <span>Citas programadas</span>
            </div>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">calendar_month</span></div>
          <div class="kpi-content">
            <h3>Citas del Mes</h3>
            <div class="kpi-value">{{ citasMesActual }}</div>
            <div class="kpi-details">
              <span>Mes actual</span>
            </div>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">today</span></div>
          <div class="kpi-content">
            <h3>Citas de Hoy</h3>
            <div class="kpi-value">{{ citasHoy }}</div>
            <div class="kpi-details">
              <span>Día actual</span>
            </div>
          </div>
        </div>
        -->

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">medical_services</span></div>
          <div class="kpi-content">
            <h3>Especialidad Top</h3>
            <div class="kpi-value">{{ porcentajeEspecialidadTop }}%</div>
            <div class="kpi-details">
              <span>{{ especialidadMasPedida || 'Sin datos' }}</span>
            </div>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">pie_chart</span></div>
          <div class="kpi-content">
            <h3>Más Solicitada</h3>
            <div class="kpi-value">{{ porcentajeEspecialidadTop }}%</div>
            <div class="kpi-details">
              <span>{{ especialidadMasPedida || 'Sin datos' }}</span>
            </div>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">schedule</span></div>
          <div class="kpi-content">
            <h3>Ocupación Horarios</h3>
            <div *ngIf="kpiOcupacion; else noOcupacion">
              <div class="kpi-value">{{ kpiOcupacion!.percent }}%</div>
              <div class="kpi-details">
                <span>{{ kpiOcupacion!.ocupados }} de {{ kpiOcupacion!.total }} horarios</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar" [style.width.%]="kpiOcupacion!.percent"></div>
              </div>
            </div>
            <ng-template #noOcupacion>
              <div class="kpi-value">-</div>
              <div class="kpi-details">Sin datos</div>
            </ng-template>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-icon"><span class="material-icons">cancel</span></div>
          <div class="kpi-content">
            <h3>Tasa Cancelación</h3>
            <div *ngIf="kpiCancelacion; else noCancelacion">
              <div class="kpi-value">{{ kpiCancelacion!.percent }}%</div>
              <div class="kpi-details">
                <span>{{ kpiCancelacion!.canceladas }} de {{ kpiCancelacion!.total }} citas</span>
              </div>
              <div class="kpi-progress">
                <div class="kpi-progress-bar kpi-progress-bar-warning" [style.width.%]="kpiCancelacion!.percent"></div>
              </div>
            </div>
            <ng-template #noCancelacion>
              <div class="kpi-value">-</div>
              <div class="kpi-details">Sin datos</div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- BI Charts Section -->
      <div class="charts-section">
        <h2 class="section-title"><span class="material-icons section-icon">bar_chart</span> Análisis Visual</h2>

        <!-- Row 1: Bar Chart + Line Chart -->
        <div class="charts-row">
          <div class="chart-card">
            <h3><span class="material-icons chart-icon">bar_chart</span> Citas por Especialidad</h3>
            <div id="chartEspecialidad" class="chart-container"></div>
          </div>

          <div class="chart-card">
            <h3><span class="material-icons chart-icon">show_chart</span> Tendencia Temporal (Mes)</h3>
            <div id="chartTemporal" class="chart-container"></div>
          </div>
        </div>

        <!-- Row 2: Heatmap + User Growth -->
        <div class="charts-row">
          <div class="chart-card">
            <h3><span class="material-icons chart-icon">grid_on</span> Mapa de Calor - Horarios Demandados</h3>
            <div id="chartHeatmap" class="chart-container"></div>
          </div>

          <div class="chart-card">
            <h3><span class="material-icons chart-icon">trending_up</span> Crecimiento de Usuarios</h3>
            <div id="chartUsuarios" class="chart-container"></div>
          </div>
        </div>

        <!-- Row 3: Gauge Chart -->
        <div class="charts-row">
          <div class="chart-card full-width">
            <h3><span class="material-icons chart-icon">speed</span> Indicador de Asistencia</h3>
            <div id="chartGauge" class="chart-container"></div>
          </div>
        </div>
      </div>
    </div>
</div>
